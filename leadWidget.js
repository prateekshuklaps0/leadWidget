class LeadWidget{constructor(e){this.encrypted=e;const t=document.createElement("link");t.rel="stylesheet",t.href="https://lead-widget.vercel.app/leadWidget.css",document.head.appendChild(t),this.loadFilestackScript().then((()=>this.initializeWidget())).catch((e=>console.error("Error loading Filestack script:",e)))}loadFilestackScript(){return new Promise(((e,t)=>{if(window.filestack)return e();const i=document.createElement("script");i.src="//static.filestackapi.com/filestack-js/3.x.x/filestack.min.js",i.onload=()=>e(),i.onerror=()=>t(new Error("Failed to load Filestack script")),document.head.appendChild(i)}))}initializeWidget(){const e=JSON.parse(window.atob(this.encrypted));for(let t in e)this[t]=e[t];this.iFrameDiv=document.querySelector(`.frame-${this.widgetData?.uuid}`),this.resErrorElement=document.createElement("p"),this.iframeInit()}fieldInpVals={};isSubmitLoading=!1;fieldErrors={};handleUpload=async({accept:e}={})=>new Promise(((t,i)=>{filestack.init(this.fileStackKey).picker({accept:e||["image/*",".pdf"],maxFiles:1,uploadInBackground:!1,maxSize:2097152,onUploadDone:e=>{e?.filesFailed?.length>0&&i(new Error("Error uploading files :",e?.filesFailed)),e?.filesUploaded?.length>0&&0==e?.filesFailed?.length&&t(e?.filesUploaded)}}).open()}));createElement=(e,t={},i={})=>{const a=document.createElement(e);Object.assign(a.style,t);for(const e in i)a.setAttribute(e,i[e]);return a};showError=(e,t)=>{e.classList.add("visible"),e.textContent=t};createLabel=({text:e,styles:t={},...i})=>{const a=this.createElement("label",t,{...i});return a.textContent=e,a};createButton=({text:e,styles:t={},onClick:i,...a})=>{const s=this.createElement("button",t,{...a});return s.textContent=e,s.onclick=i,s};createParagraph=(e,t={},i={})=>{const a=this.createElement("p",t);a.textContent=e;for(const e in i)a.setAttribute(e,i[e]);return a};getFieldType=e=>{switch(e){case"telephone":case"phone":return"number";case"calendar":return"date";case"textbox":return"text";case"dropdown":return"select";case"fileUpload":return"file";default:return e}};createRadioInp=e=>{const t=this.createElement("div",{},{class:"radio-cont-div"});return t.innerHTML=e?.options?.map((t=>`<div class="radio-options-cont">\n            <input type="radio" name="${e?.uuid}" value="${t?.uuid}" id="${t?.uuid}" class="radio-opts">\n             <label for="${t?.uuid}" >${t?.label}</label>\n            </div>`)).join(""),t.onchange=e=>{const{name:t,value:i}=e.target;this.fieldInpVals={...this.fieldInpVals,[t]:i},this.resErrorElement.innerHTML="",this.resErrorElement.removeAttribute("class")},t};createCheckboxInp=e=>{const t=this.createElement("div",{},{class:"radio-cont-div"});return t.innerHTML=e?.options?.map((t=>`<div class="radio-options-cont">\n            <input type="checkbox" name="${e?.uuid}" value="${t?.uuid}" id="${t?.uuid}" class="checkbox-opts">\n            <label for="${t?.uuid}" >${t?.label}</label>\n            </div>`)).join(""),t.onchange=e=>{const{name:t,value:i,checked:a}=e.target;this.fieldInpVals={...this.fieldInpVals,[t]:a?[...this.fieldInpVals[t]||[],i]:[...(this.fieldInpVals[t]||[]).filter((e=>e!=i))]},this.resErrorElement.innerHTML="",this.resErrorElement.removeAttribute("class")},t};createSelectInp=e=>{const t=this.createElement("select",{},{name:e?.uuid||"",placeholder:e?.placeholder||"Select Option",required:e?.isRequired||!1});return t.innerHTML=`<option value="" class="slct-placeholder">${e?.placeholder||"Select Option"}</option>\n${e?.options?.map((e=>`<option value="${e?.uuid}">${e?.label}</option>`)).join("")}`,t.onchange=e=>{const{name:t,value:i}=e.target;this.fieldInpVals={...this.fieldInpVals,[t]:i},this.resErrorElement.innerHTML="",this.resErrorElement.removeAttribute("class")},t};createInput(e,t){const i="textarea"==t,a=this.createElement(i?"textarea":"input",{},{type:t,name:e?.uuid||"",placeholder:e?.placeholder||"",required:e?.isRequired||!1});return a.onchange=e=>{const{name:t,value:i}=e.target;this.fieldInpVals={...this.fieldInpVals,[t]:i},this.resErrorElement.innerHTML="",this.resErrorElement.removeAttribute("class")},a}createFileInp=e=>{const t=this.createElement("input",{},{type:"file",name:e?.uuid||"",placeholder:e?.placeholder||"",required:e?.isRequired||!1});return t.onchange=e=>{const{name:t,value:i}=e.target;this.fieldInpVals={...this.fieldInpVals,[t]:{fileName:i,value:i}},this.resErrorElement.innerHTML="",this.resErrorElement.removeAttribute("class")},t};showFieldErrors=()=>{for(let e in this.fieldErrors){const t=this.fieldErrors[e],i=document.querySelector(`[class="field-item-div ${e}"]`);if(i){return void(i.querySelector(".field-error").innerHTML=t)}console.error(`No field element found for field ${e}`)}};setBtnLoading=({status:e,btnElement:t,btnText:i,error:a})=>{this.isSubmitLoading="pending"==e,t.innerHTML="pending"==e?'<span class="submit-widget-loader"></span>':i||"Submit",this.resErrorElement.innerHTML="error"==e?a||"Something went wrong":"","error"==e?this.resErrorElement.setAttribute("class","res-error"):this.resErrorElement.removeAttribute("class")};renderFields(){const e=this.createElement("div",{},{class:"fields-Cont"});return Array.isArray(this.fieldsData)?(this.fieldsData.forEach((t=>{const i=this.getFieldType(t?.type),a=this.createElement("div",{},{class:`${"file"==i?"custom-file-upload":"field-item-div"} ${t?.uuid}`}),s=this.createParagraph(t?.placeholder||"Choose File",{},{}),r=this.createElement("span",{},{});r.innerHTML="Browse",r.addEventListener("click",(async e=>{e.stopPropagation(),await this.handleUpload().then((e=>{s.innerHTML=e[0]?.filename||"",s.append(r);const i=`https://filestack.mastersunion.org/${e[0]?.key}`;this.fieldInpVals[t?.uuid]={filename:e[0]?.filename||"",url:i}})).catch((e=>{console.log("fieldUpload error :",e)}))})),s.append(r);const n=this.createLabel({text:t?.label||""});if(t?.isRequired){const e=this.createElement("span");e.innerHTML=" *",n.append(e)}let o;o="radio"==i?this.createRadioInp(t):"checkbox"==i?this.createCheckboxInp(t):"select"==i?this.createSelectInp(t):"file"==i?this.createFileInp(t):["textarea","text","number","email","date"].includes(i)?this.createInput(t,i):"otp"==i?this.createInput(t,"number"):this.createInput(t,i);const l=this.createElement("span",{},{class:"field-error"});"file"==i?a.append(n,s,o,l):a.append(n,o,l),e.appendChild(a)})),e):console.error("`this.fieldsData` is not an array or is :",this.fieldsData)}async sendRequest(e){return await fetch(`${this.submitApiData?.api_Url_origin}${this.submitApiData?.api_Url}`,{method:this.submitApiData?.method?.toUpperCase(),headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":this.submitApiData?.api_Url_origin,"Access-Control-Allow-Methods":"POST, GET","Access-Control-Allow-Headers":"pragma","Access-Control-Max-Age":1728e3},body:JSON.stringify(e)})}async iframeInit(){const e=this.renderFields(),t=this.createButton({text:"Submit",type:"submit",class:"iframeBtn"});t.addEventListener("click",(async()=>{if(this.isSubmitLoading)return;const e=this.fieldsData?.map((e=>{let t={fieldUuid:e?.uuid,label:e?.label};const i=this.getFieldType(e?.type);return["select","radio"].includes(i)?t.selectedOptions=e?.options?.filter((t=>t.uuid==this.fieldInpVals[e?.uuid])):"file"==i?(t.value=(this.fieldInpVals[e?.uuid]||{})?.url,t.filename=(this.fieldInpVals[e?.uuid]||{})?.filename):"checkbox"==i?t.selectedOptions=(this.fieldInpVals[e?.uuid]||[]).map((t=>e?.options?.find((e=>e?.uuid==t)))):t.value=(this.fieldInpVals[e?.uuid]||"").trim(),t})),i=new URLSearchParams(window.location.search),a=i.get("utm_source")||this.widgetData?.source||"",s=i.get("utm_medium")||this.widgetData?.medium||"",r=i.get("utm_campaign")||this.widgetData?.campaign||"",n=i.get("utm_term")||this.widgetData?.utm_term||"",o=i.get("utm_content")||this.widgetData?.utm_content||"",l={theme:this.theme||"",widgetType:this.widgetType||"",formData:this.formData||{},programData:this.programData||{},..."leadmanager"==this.widgetType?.toLowerCase()?{afterLeadCaptureActionData:this.afterLeadCaptureActionData||{}}:{thankYouPageData:this.thankYouPageData||{}},widgetData:this.widgetData||{},UTMData:{utm_source:a,utm_medium:s,utm_campaign:r,utm_term:n,utm_content:o},fieldsData:e};console.log("payload",JSON.stringify(l,null,2)),this.setBtnLoading({status:"pending",btnElement:t});try{const e=await this.sendRequest(l),i=await e.json();if(!e?.ok)return console.log("Error while submitting widget data :",i),void this.setBtnLoading({status:"error",btnElement:t,error:i?.message});console.log("Widget Submitted Successfully :",i?.data);const{token:a,applicationManagerId:s}=i?.data||{},r=this.thankYouPageData?.isRedirect?this.thankYouPageData?.websiteUrl:`${this.submitApiData?.lead_link_domain}${this.submitApiData?.lead_link_subroute}/${s}?t=0&token=${a}`,n="leadmanager"==this.widgetType?.toLowerCase()?this.afterLeadCaptureActionData?.actionLink:r;"leadmanager"==this.widgetType?.toLowerCase()&&this.afterLeadCaptureActionData?.isDowloadable?fetch(this.afterLeadCaptureActionData?.actionLink||"").then((e=>{if(!e.ok)throw new Error("Failed to fetch the PDF file");return e.blob()})).then((e=>{const t=window.URL.createObjectURL(e),i=document.createElement("a");i.href=t,i.download=this.programData?.name||"",document.body.appendChild(i),i.click(),document.body.removeChild(i),window.URL.revokeObjectURL(t),this.renderAfterDownload()})).catch((e=>{console.error("Error downloading the PDF:",e)})):window.location.href=n,this.setBtnLoading({status:"success",btnElement:t})}catch(e){console.log("Failed to submit widget data :",e),this.setBtnLoading({status:"error",btnElement:t,error:e})}}));const i=this.createElement("div",{},{class:"submit-widget-btn-cont"});i.append(t),this.iFrameDiv.classList="iFrameWidgetDiv "+("tetr"==this.theme?"tetr-widget":"MU dark"==this.theme?"mu-dark-widget":"mu-light-widget"),this.iFrameDiv.append(e,i,this.resErrorElement),this.showFieldErrors(),console.log(this.theme,"widget iframe loaded")}async renderAfterDownload(){this.iFrameDiv.innerHTML='<div class="afterFileDownloadSuccess">\n            <div id="SuccessMessage" class="congrats-box">\n                <img src="https://files.mastersunion.link/assets/img/thankyou_logo.svg" alt="">\n                <h3 class="thankyouboxHeading mt-10 gtmUgDwnBroGotit" id="gtmUgDwnBroGotitId">Thank You</h3>\n                <p class="text-2 gtmUgDwnBroGotPara" id="gtmUgDwnBroGotParaId">You\'ve sucessfully downloaded our Placement Report</p>\n            </div>\n        </div>'}}
